<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Google Calendar part 3: Webhook synchronizations</title>
    <meta name="description" content="In this article we&#39;ll go one step further and ask the Google API to notify us of any changes that we should be aware of.">
    
    
    <link rel="preload" href="/assets/css/0.styles.d1fafc99.css" as="style"><link rel="preload" href="/assets/js/app.f0379f84.js" as="script"><link rel="preload" href="/assets/js/2.f113c167.js" as="script"><link rel="preload" href="/assets/js/6.3a66a41c.js" as="script"><link rel="prefetch" href="/assets/js/10.463c40b2.js"><link rel="prefetch" href="/assets/js/11.41347932.js"><link rel="prefetch" href="/assets/js/12.160cf6fa.js"><link rel="prefetch" href="/assets/js/13.869049d5.js"><link rel="prefetch" href="/assets/js/14.6ab5dbac.js"><link rel="prefetch" href="/assets/js/15.5b213614.js"><link rel="prefetch" href="/assets/js/16.9b9d25f1.js"><link rel="prefetch" href="/assets/js/17.53e9786c.js"><link rel="prefetch" href="/assets/js/18.407766eb.js"><link rel="prefetch" href="/assets/js/19.ad818b5a.js"><link rel="prefetch" href="/assets/js/20.6a6cbda5.js"><link rel="prefetch" href="/assets/js/21.16473eda.js"><link rel="prefetch" href="/assets/js/22.17daa536.js"><link rel="prefetch" href="/assets/js/23.a3b585a7.js"><link rel="prefetch" href="/assets/js/24.693bd400.js"><link rel="prefetch" href="/assets/js/25.1cb8e654.js"><link rel="prefetch" href="/assets/js/3.e245ae37.js"><link rel="prefetch" href="/assets/js/4.32ef7c1a.js"><link rel="prefetch" href="/assets/js/5.1fabd509.js"><link rel="prefetch" href="/assets/js/7.9038972a.js"><link rel="prefetch" href="/assets/js/8.0cd2f1f4.js"><link rel="prefetch" href="/assets/js/9.1449d7bd.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d1fafc99.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="content default"><h1 id="google-calendar-part-3-webhook-synchronizations"><a href="#google-calendar-part-3-webhook-synchronizations" aria-hidden="true" class="header-anchor">#</a> Google Calendar part 3: Webhook synchronizations</h1> <p>Now that our users' calendars and events are being <a href="/google-calendar-part-1-integration">fetched (part1)</a> and <a href="/google-calendar-part-2-periodic-synchronizations">periodically synchronized (part2)</a>, let's go one step further and ask the Google API to notify us of any changes that we should be aware of.</p> <h2 id="brainstorming"><a href="#brainstorming" aria-hidden="true" class="header-anchor">#</a> Brainstorming</h2> <p>Let's start by working our way towards a solution that makes sense for our application without using any code.</p> <h3 id="what-we-have"><a href="#what-we-have" aria-hidden="true" class="header-anchor">#</a> What we have</h3> <p>Currently whenever a <code>Synchronization</code> object is created, it is initially <code>ping</code>ed to ensure the data is originally fetched and then <code>ping</code>ed again every 15 minutes through the scheduled <code>PeriodicSynchronizations</code> job.</p> <p><img src="/assets/img/Part-3---as-is.07a680cb.png#w100" alt="Current situation diagram"></p> <h3 id="what-we-want"><a href="#what-we-want" aria-hidden="true" class="header-anchor">#</a> What we want</h3> <p>In this article, we want to reach a point were we do not need to wait 15 minutes anymore but rather we let Google tell us when something needs to be updated.</p> <p>Fortunately for us, the Google API allows webhook notifications through what they call <code>Google Channels</code>. As soon as a <code>Synchronization</code> is created, we will send a request to Google to create a new <code>Google Channel</code> specifying which resource we want to listen to and which URL we should be notified on. Once a <code>Google Channel</code> is created, it will use the provided parameters to notify us as soon as the resource is updated.</p> <p>However, the way Google notifies us is very minimalistic. It does not tell us what changed exactly nor whether the resource should be deleted. All it does is call the provided URL with the resource identifier in the body of the request, basically telling us: &quot;Look, I don't know what happened exactly but something changed with this resource&quot;. It is then our responsibility to find out what changed by making additional calls to the Google API.</p> <p>At this point, the decisions made in the previous articles should start to make more sense. Google webhooks are just &quot;update pings&quot; which is exactly how we've structured our <code>Synchronization</code> model. Whenever a <code>Google Channel</code> is telling us that a resource was updated, all we need to do is find the appropriate <code>Synchronization</code> model and <code>ping()</code> it. That's it!</p> <p><img src="/assets/img/Part-3---to-be.f1725ebc.png#w100" alt="Desired situation diagram"></p> <p><small>We will use a dedicated <code>GoogleWebhookController</code> to listen to those Google updates. Also note that, even though we are setting up webhook notifications for resources like <code>GoogleAccounts</code> and <code>Calendars</code>, we are only dealing with <code>Synchronizations</code> which free the formers of that burden.</small></p> <h3 id="a-hybrid-solution"><a href="#a-hybrid-solution" aria-hidden="true" class="header-anchor">#</a> A hybrid solution</h3> <p>To make things more complicated, some Google resources do not support webhook notifications, i.e. creating a <code>Google Channel</code> for that resource will raise an exception. This is typically the case for globally shared calendars like &quot;Public holidays in the US&quot;.</p> <p>So when that happens, we will simply catch that exception and fallback to periodic synchronizations. At least our previous implementation was not done in vain.</p> <p><img src="/assets/img/Part-3---to-be-hybrid.53f955f1.png" alt="Hybrid situation diagram"></p> <h3 id="stopping-webhooks"><a href="#stopping-webhooks" aria-hidden="true" class="header-anchor">#</a> Stopping webhooks</h3> <p>Whenever a <code>Synchronization</code> is deleted, we should make sure we stop listening for changes on its associated resource. We simply do this by deleting the <code>Google Channel</code> that was created for that purpose.</p> <p>Trivially if the resource does not support webhooks, no <code>Google Channel</code> was created and there is nothing to do here.</p> <p><img src="/assets/img/Part-3---to-be-deleted.3952a3de.png" alt="Stopping webhooks diagram"></p> <h3 id="refreshing-webhooks"><a href="#refreshing-webhooks" aria-hidden="true" class="header-anchor">#</a> Refreshing webhooks</h3> <p>One last piece of bad news: like almost everything in the Google API, <code>Google Channels</code> expire. Whenever a new <code>Google Channel</code> is created we also get an expiration timestamp that is usually about a week from now.</p> <p>Therefore, we need a new job that periodically goes through each <code>Synchronization</code> associated with a <code>Google Channel</code> and refreshes the ones that are about to expire.</p> <p>We refresh a synchonization by turning the webhook notifications off and on again. We also need to make sure a new UUID is provided to the <code>Synchronization</code> since the current UUID has already been used to create the previous <code>Google Channel</code>.</p> <p><img src="/assets/img/Part-3---to-be-refreshed.830bed40.png" alt="Refreshing webhooks diagram"></p> <h2 id="preparing-for-changes"><a href="#preparing-for-changes" aria-hidden="true" class="header-anchor">#</a> Preparing for changes</h2> <h3 id="boosting-up-synchronizations"><a href="#boosting-up-synchronizations" aria-hidden="true" class="header-anchor">#</a> Boosting up synchronizations</h3> <p>Now that <code>Synchronizations</code> will be used to create <code>Google Channels</code> and associated with a particular resource identifier, we need to update its schema.</p> <p>Particularly, we are going to add a <code>resource_id</code> string and a <code>expired_at</code> datetime, both provided by the newly create <code>Google Channel</code>. Since some resources don't support webhook notifications we need to make sure those new fields are <code>nullable</code>.</p> <div class="language-php extra-class"><pre class="language-php"><code>Schema<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'synchronizations'</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>Blueprint <span class="token variable">$table</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'resource_id'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">nullable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$table</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">datetime</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'expired_at'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">nullable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>We also need to make sure these fields are mass-assignable and casted properly.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">Synchronization</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$fillable</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token comment">// ...</span>
        <span class="token single-quoted-string string">'resource_id'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'expired_at'</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token keyword">protected</span> <span class="token variable">$casts</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token comment">// ...</span>
        <span class="token single-quoted-string string">'expired_at'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'datetime'</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    
    <span class="token comment">// ...</span>
</code></pre></div><p>Finally, we refresh our database by running <code>php artisan migration:fresh</code> since we've updated our migrations.</p> <p><small>Alternatively, you can always create a new migration and run <code>php artisan migrate</code>.</small></p> <p><small>üêô <a href="https://github.com/lorisleiva/blog-google-calendar/commit/02ca77e45925782378e2646f757fa6e3a7c804c6" target="_blank" rel="noopener noreferrer">See changes on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></small></p> <h3 id="refactoring-the-way-we-access-google-tokens"><a href="#refactoring-the-way-we-access-google-tokens" aria-hidden="true" class="header-anchor">#</a> Refactoring the way we access Google tokens</h3> <p>There is a little bit a refactoring that I think we should do before continuing. Whenever we need to make calls to the Google API through our <code>Google</code> service, we need to provide a authentication token that lives in the <code>GoogleAccount</code> model. However, <code>Synchronizables</code> can be <code>GoogleAccounts</code> but also <code>Calendars</code>. Therefore whether the <code>Synchronization</code> is associated with one or the other, it changes the way we need to access this authentication token.</p> <p>Currently, we are dealing with this in the subclasses of the <code>SynchronizeGoogleResource</code> job.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// app/Jobs/SynchronizeGoogleCalendars</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getGoogleService</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">app</span><span class="token punctuation">(</span>Google<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">)</span>
        <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">connectUsing</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">synchronizable</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">token</span><span class="token punctuation">)</span> <span class="token comment">// Here we access the token directly.</span>
        <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Calendar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// app/Jobs/SynchronizeGoogleEvents</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getGoogleService</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">app</span><span class="token punctuation">(</span>Google<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">)</span>
        <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">connectUsing</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">synchronizable</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">googleAccount</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">token</span><span class="token punctuation">)</span> <span class="token comment">// Here we access it through the googleAccount relationship.</span>
        <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Calendar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>In my opinion, this is a perfectly valid place to keep that logic whithin the current state of our application. However, we are about to need more and more access to Google tokens and it seems like a good time to extract that logic into a more appropriate location.</p> <p>Wouldn't it be easier if the <code>Google</code> service could take resposibility of finding the right token from a <code>Synchronizable</code>? We could have a <code>connectWithSynchronizable</code> method that simply accepts a <code>Synchronizable</code> and takes care of authenticating us to the Google API. Let's try that.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">Google</span>
<span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">connectWithSynchronizable</span><span class="token punctuation">(</span><span class="token variable">$synchronizable</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$token</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getTokenFromSynchronizable</span><span class="token punctuation">(</span><span class="token variable">$synchronizable</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">connectUsing</span><span class="token punctuation">(</span><span class="token variable">$token</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function">getTokenFromSynchronizable</span><span class="token punctuation">(</span><span class="token variable">$synchronizable</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">switch</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">case</span> <span class="token variable">$synchronizable</span> <span class="token keyword">instanceof</span> <span class="token class-name">GoogleAccount</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token variable">$synchronizable</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">token</span><span class="token punctuation">;</span>

            <span class="token keyword">case</span> <span class="token variable">$synchronizable</span> <span class="token keyword">instanceof</span> <span class="token class-name">Calendar</span><span class="token punctuation">:</span>
                <span class="token keyword">return</span> <span class="token variable">$synchronizable</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">googleAccount</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">token</span><span class="token punctuation">;</span>
            
            <span class="token keyword">default</span><span class="token punctuation">:</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name"><span class="token punctuation">\</span>Exception</span><span class="token punctuation">(</span><span class="token double-quoted-string string">&quot;Invalid Synchronizable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><small>Note the use of <code>switch (true)</code> instead of multiple <code>if</code> statements. This trick can be useful to bring more clarity to your conditionals and display your logic in a more &quot;pattern matching&quot; style.</small></p> <p>We can now change the previous synchronization jobs to use this new method.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// app/Jobs/SynchronizeGoogleCalendars</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getGoogleService</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">app</span><span class="token punctuation">(</span>Google<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">)</span>
        <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">connectWithSynchronizable</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">synchronizable</span><span class="token punctuation">)</span>
        <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Calendar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// app/Jobs/SynchronizeGoogleEvents</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getGoogleService</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">app</span><span class="token punctuation">(</span>Google<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">)</span>
        <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">connectWithSynchronizable</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">synchronizable</span><span class="token punctuation">)</span>
        <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Calendar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Since these methods are now completely identical we can delete them altogether, and push that logic to the super class. Even better, we can create a helper function on the <code>Synchronizable</code> trait that authenticates us to the Google API and returns the desired Google service.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">trait</span> <span class="token class-name">Synchronizable</span>
<span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getGoogleService</span><span class="token punctuation">(</span><span class="token variable">$service</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">app</span><span class="token punctuation">(</span>Google<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">)</span>
            <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">connectWithSynchronizable</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token punctuation">)</span>
            <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">service</span><span class="token punctuation">(</span><span class="token variable">$service</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">SynchronizeGoogleResource</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>
        
        <span class="token variable">$service</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">synchronizable</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getGoogleService</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Calendar'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><small>üêô <a href="https://github.com/lorisleiva/blog-google-calendar/commit/9959fd34e5932b0a89c3c0defd4f0e424163430b" target="_blank" rel="noopener noreferrer">See changes on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></small></p> <h2 id="watching-google-resources"><a href="#watching-google-resources" aria-hidden="true" class="header-anchor">#</a> Watching Google resources</h2> <p>We're now all ready to get started with webhook synchronizations. As we've seen in the brainstorming section, we first need to create a <code>Google Channel</code> associated with the right resource. That is:</p> <ul><li>A <code>GoogleAccount</code> if we want to listen for changes within its calendars.</li> <li>A <code>Calendar</code> if we want to listen for changes within its events.</li></ul> <p>Similarly to the jobs responsible to synchronize calendars and events from the Google API, we will create one abstract class that describes the communication protocol of creating a new <code>Google Channel</code> and two specific sub-classes that fill the missing gaps.</p> <p><img src="/assets/img/Part-3---watch-jobs.0d7598c4.png" alt="WatchGoogleResource UML"></p> <h3 id="the-abstract-class"><a href="#the-abstract-class" aria-hidden="true" class="header-anchor">#</a> The abstract class</h3> <p>Let's start by defining the skeleton of the abstract class <code>WatchGoogleResource</code>. Similarly to the <code>SynchronizeGoogleResource</code>, it accepts a <code>Synchronizable</code> and forces the sub-classes to implement a <code>getGoogleRequest</code> method.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">namespace</span> <span class="token package">App<span class="token punctuation">\</span>Jobs</span><span class="token punctuation">;</span>

<span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">WatchGoogleResource</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$synchronizable</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__construct</span><span class="token punctuation">(</span><span class="token variable">$synchronizable</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">synchronizable</span> <span class="token operator">=</span> <span class="token variable">$synchronizable</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// Make a call to the Google API</span>
        <span class="token comment">// to create a new Google Channel.</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">abstract</span> <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getGoogleRequest</span><span class="token punctuation">(</span><span class="token variable">$service</span><span class="token punctuation">,</span> <span class="token variable">$channel</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Starting a webhook on a Google resource is a rather simple process, we need to:</p> <ol><li>Request the <strong>creation of a Google Channel</strong>. Since this task is delegated to the sub-classes, we simply need to give them the right data. I.e. the Google calendar service and the webhook parameters as a <code>Google_Service_Calendar_Channel</code> object ‚Äî implemented in the next section.</li> <li>Use the response to <strong>update the synchronization model</strong>. This part is important to ensure we can link a <code>resouce_id</code> ‚Äî the only information provided by the webhooks ‚Äî with the right <code>Synchronization</code>.</li></ol> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$synchronization</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">synchronizable</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">synchronization</span><span class="token punctuation">;</span>

    <span class="token variable">$response</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getGoogleRequest</span><span class="token punctuation">(</span>
        
        <span class="token comment">// Thanks to our previous refactoring we can now grab the</span>
        <span class="token comment">// Google Calendar service directly from the synchronizable.</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">synchronizable</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getGoogleService</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Calendar'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        
        <span class="token comment">// We will implement this in the next section.</span>
        <span class="token comment">// It uses the synchronization's data to create</span>
        <span class="token comment">// a new \Google_Service_Calendar_Channel object.</span>
        <span class="token variable">$synchronization</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">asGoogleChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// We can now update our synchronization model</span>
    <span class="token comment">// with the provided resource_id and expired_at.</span>
    <span class="token variable">$synchronization</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
        <span class="token single-quoted-string string">'resource_id'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$response</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getResourceId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token single-quoted-string string">'expired_at'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> Carbon<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">createFromTimestampMs</span><span class="token punctuation">(</span><span class="token variable">$response</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getExpiration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>However, we've seen that some resources cannot be watched via webhooks and will raise an exception if you try to create a <code>Google Channel</code> associated with them. Therefore we need to wrap all of that in a try/catch and ignore the right exception.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>

    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name"><span class="token punctuation">\</span>Google_Service_Exception</span> <span class="token variable">$e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// If we reach an error at this point, it is likely that</span>
        <span class="token comment">// webhook notifications are forbidden for this resource.</span>
        <span class="token comment">// Instead we will sync it manually at regular interval.</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>The synchronizations associated with resources that do not support webhook notifications will now have an empty <code>resource_id</code> and <code>expired_at</code>. Thus, we need to update our scheduled <code>PeriodicSynchronizations</code> job to only <code>ping()</code> the synchronizations without a <code>resource_id</code>.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">PeriodicSynchronizations</span> <span class="token keyword">implements</span> <span class="token class-name">ShouldQueue</span>
<span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>   
        Synchronization<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">whereNull</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'resource_id'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">each</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="from-synchronizations-to-channels"><a href="#from-synchronizations-to-channels" aria-hidden="true" class="header-anchor">#</a> From synchronizations to channels</h3> <p>As mentioned above, a <code>Google_Service_Calendar_Channel</code> object is required to start a webhook. This object accepts four parameters:</p> <ul><li>A unique <code>id</code> within the scope of our application. We can provide whatever we want but the same <code>id</code> can never <em>ever</em> be used twice. Using UUIDs instead of auto-incremented integers makes this task a lot easier.</li> <li>A <code>resourceId</code> if the synchronization already has an associated <code>Google Channel</code>. At first ‚Äî when starting a new webhook ‚Äî this will be <code>null</code> and therefore can be ignored. However, this will be useful later on when we need to stop the webhook.</li> <li>A <code>type</code> which simply needs to be <code>&quot;web_hook&quot;</code>.</li> <li>Finally, the <code>address</code> we want Google to use to notify us. In our case, we've already defined this in the configurations in <a href="/google-calendar-part-1-integration#googleasaservice">part 1</a> of this series.</li></ul> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">Synchronization</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">asGoogleChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">tap</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name"><span class="token punctuation">\</span>Google_Service_Calendar_Channel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$channel</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$channel</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$channel</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setResourceId</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">resource_id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$channel</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setType</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'web_hook'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$channel</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">setAddress</span><span class="token punctuation">(</span><span class="token function">config</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'services.google.webhook_uri'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="the-sub-classes"><a href="#the-sub-classes" aria-hidden="true" class="header-anchor">#</a> The sub-classes</h3> <p>Now that the main communication protocol has been established, we simply need to create two sub-classes that fill the missing pieces, i.e. implement the <code>getGoogleRequest</code> method. A quick browse through the Google API and we're good to go.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">WatchGoogleCalendars</span> <span class="token keyword">extends</span> <span class="token class-name">WatchGoogleResource</span> <span class="token keyword">implements</span> <span class="token class-name">ShouldQueue</span>
<span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token package">Dispatchable</span><span class="token punctuation">,</span> InteractsWithQueue<span class="token punctuation">,</span> Queueable<span class="token punctuation">,</span> SerializesModels<span class="token punctuation">;</span>
    
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getGoogleRequest</span><span class="token punctuation">(</span><span class="token variable">$service</span><span class="token punctuation">,</span> <span class="token variable">$channel</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$service</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">calendarList</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token variable">$channel</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">WatchGoogleEvents</span> <span class="token keyword">extends</span> <span class="token class-name">WatchGoogleResource</span> <span class="token keyword">implements</span> <span class="token class-name">ShouldQueue</span>
<span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token package">Dispatchable</span><span class="token punctuation">,</span> InteractsWithQueue<span class="token punctuation">,</span> Queueable<span class="token punctuation">,</span> SerializesModels<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getGoogleRequest</span><span class="token punctuation">(</span><span class="token variable">$service</span><span class="token punctuation">,</span> <span class="token variable">$channel</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$service</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">events</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">watch</span><span class="token punctuation">(</span>
            <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">synchronizable</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">google_id</span><span class="token punctuation">,</span> <span class="token variable">$channel</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><small>üêô <a href="https://github.com/lorisleiva/blog-google-calendar/commit/3e75ff9458d3f25ce37d9d2e9ab3d6816017801e" target="_blank" rel="noopener noreferrer">See changes on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></small></p> <h2 id="controlling-webhooks"><a href="#controlling-webhooks" aria-hidden="true" class="header-anchor">#</a> Controlling webhooks</h2> <p>In this section we will add some logic to the <code>Synchronization</code> model and the <code>Synchronizable</code> trait in order to start, stop and refresh webhooks.</p> <h3 id="start"><a href="#start" aria-hidden="true" class="header-anchor">#</a> Start</h3> <p><img src="/assets/img/Part-3---to-be-hybrid.53f955f1.png" alt="Hybrid solution diagram"></p> <p>Most of the work has been done here. All we need is a nice way to call the relevant <code>WatchGoogleXXX</code> jobs. We will use a similar approach to the way we currently call the <code>SynchronizeGoogleXXX</code> jobs.</p> <p>First, we implement our starting point <code>startListeningForChanges</code> which delegates to the associated <code>Synchronizable</code>.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">Synchronization</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">startListeningForChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">synchronizable</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Next, we force synchronizables to implement this <code>watch</code> method.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">trait</span> <span class="token class-name">Synchronizable</span>
<span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    
    <span class="token keyword">abstract</span> <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Finally, we implement it for the <code>GoogleAccount</code> and <code>Calendar</code> models.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">GoogleAccount</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        WatchGoogleCalendars<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">Calendar</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">watch</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        WatchGoogleEvents<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="stop"><a href="#stop" aria-hidden="true" class="header-anchor">#</a> Stop</h3> <p><img src="/assets/img/Part-3---to-be-deleted.3952a3de.png" alt="Stopping webhooks diagram"></p> <p>Stopping a webhook is relatively simple and always done via the same endpoint. Therefore there is no need to create yet another set of jobs for this purpose.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">Synchronization</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">stopListeningForChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// If resource_id is null then the synchronization</span>
        <span class="token comment">// does not have an associated Google Channel and</span>
        <span class="token comment">// therefore there is nothing to stop at this point.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">resource_id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">synchronizable</span>
            <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getGoogleService</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'Calendar'</span><span class="token punctuation">)</span>
            <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">channels</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">asGoogleChannel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="event-listeners"><a href="#event-listeners" aria-hidden="true" class="header-anchor">#</a> Event listeners</h3> <p><img src="/assets/img/Part-3---event-listeners.ca88a340.png" alt="Event listeners diagram"></p> <p>Let's now add some event listeners on the <code>Synchronization</code> model so that it starts the webhook upon creation and stops it upon deletion.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">Synchronization</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">function</span> <span class="token function">boot</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// ...</span>

        <span class="token comment">// We start the webhook (if possible) as soon</span>
        <span class="token comment">// as the synchronization is created and</span>
        <span class="token comment">// perform an initial synchronization.</span>
        <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">created</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$synchronization</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$synchronization</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">startListeningForChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token variable">$synchronization</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// We stop the webhook (if applicable) right</span>
        <span class="token comment">// before the synchronization is deleted.</span>
        <span class="token keyword">static</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">deleting</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$synchronization</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token variable">$synchronization</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">stopListeningForChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="refresh"><a href="#refresh" aria-hidden="true" class="header-anchor">#</a> Refresh</h3> <p><img src="/assets/img/Part-3---to-be-refreshed.830bed40.png" alt="Refreshing webhooks diagram"></p> <p>Since webhooks expire, we need to have a way of refreshing them. This is as simple as stoping and restarting the webhook except that, before starting it again, we need to generate a new synchronization UUID.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">Synchronization</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span>
<span class="token punctuation">{</span>
    <span class="token comment">// ...</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">refreshWebhook</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">stopListeningForChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Update the UUID since the previous one has </span>
        <span class="token comment">// already been associated to a Google Channel.</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">id</span> <span class="token operator">=</span> Uuid<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">uuid4</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">save</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">startListeningForChanges</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Finally, let's create a new scheduled job ‚Äî <code>php artisan make:job RefreshWebhookSynchronizations</code> ‚Äî to monitor webhook synchronizations and make sure they are refreshed before they expire.</p> <p>We select every synchronization that has a <code>resource_id</code> ‚Äî i.e. an associated <code>Google Channel</code> ‚Äî and an <code>expired_at</code> that is about to expire ‚Äî i.e. will be expired two days from now. We then call <code>refreshWebhook()</code> on all of these synchronizations.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">RefreshWebhookSynchronizations</span> <span class="token keyword">implements</span> <span class="token class-name">ShouldQueue</span>
<span class="token punctuation">{</span>
    <span class="token keyword">use</span> <span class="token package">Dispatchable</span><span class="token punctuation">,</span> InteractsWithQueue<span class="token punctuation">,</span> Queueable<span class="token punctuation">,</span> SerializesModels<span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        Synchronization<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">whereNotNull</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'resource_id'</span><span class="token punctuation">)</span>
            <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">whereNull</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'expired_at'</span><span class="token punctuation">)</span>
            <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">orWhere</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'expired_at'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'&lt;'</span><span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">addDays</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">each</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">refreshWebhook</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We will run this job daily to make sure we never reach a state were a synchronization has expired.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// app/Console/Kernel.php</span>
<span class="token keyword">protected</span> <span class="token keyword">function</span> <span class="token function">schedule</span><span class="token punctuation">(</span>Schedule <span class="token variable">$schedule</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token variable">$schedule</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">job</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PeriodicSynchronizations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">everyFifteenMinutes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token variable">$schedule</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">job</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RefreshWebhookSynchronizations</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">daily</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><small>üêô <a href="https://github.com/lorisleiva/blog-google-calendar/commit/0f853f7d3e705acf02fe3ee7cb4e963215c4cd94" target="_blank" rel="noopener noreferrer">See changes on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></small></p> <h2 id="the-webhook-controller"><a href="#the-webhook-controller" aria-hidden="true" class="header-anchor">#</a> The webhook controller</h2> <p>We're getting there! We now just need to make sure we create the endpoint that Google will use to notify us.</p> <p>We start by registering the route. Note that Google will use the <code>POST</code> method to notify us.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// ...</span>

Route<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'google.webhook'</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'google/webhook'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'GoogleWebhookController'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Next we create a new invokable controller ‚Äî i.e. that contains only one method.</p> <p><code>php artisan make:controller GoogleWebhookController -i</code></p> <p>We then define the action of that controller. It will try to find the synchronization that matches the paramaters provided by Google. If no synchronization was find it will throw a 404, otherwise it will <code>ping()</code> it.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">GoogleWebhookController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span>
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">__invoke</span><span class="token punctuation">(</span>Request <span class="token variable">$request</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// Webhooks can have two states `exists` or `sync`.</span>
        <span class="token comment">// `sync` webhooks are just notifications telling us that a</span>
        <span class="token comment">// new webhook has been created. Since we already performed</span>
        <span class="token comment">// an initial synchronization we can safely ignore them.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'x-goog-resource-state'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token single-quoted-string string">'exists'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        Synchronization<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">query</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'id'</span><span class="token punctuation">,</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'x-goog-channel-id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'resource_id'</span><span class="token punctuation">,</span> <span class="token variable">$request</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">header</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'x-goog-resource-id'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">firstOrFail</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">ping</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>We also need to remember to exclude this route from CSRF verification since it is registered in the <code>web</code> group middleware.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// app/Http/Middleware/VerifyCsrfToken.php</span>
<span class="token keyword">class</span> <span class="token class-name">VerifyCsrfToken</span> <span class="token keyword">extends</span> <span class="token class-name">Middleware</span>
<span class="token punctuation">{</span>
    <span class="token keyword">protected</span> <span class="token variable">$except</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token single-quoted-string string">'google/webhook'</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><small>üêô <a href="https://github.com/lorisleiva/blog-google-calendar/commit/5a42e4ede72efb7ec809af0628ef845f394ac8e0" target="_blank" rel="noopener noreferrer">See changes on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></small></p> <h2 id="last-details"><a href="#last-details" aria-hidden="true" class="header-anchor">#</a> Last details</h2> <h3 id="domain-verification"><a href="#domain-verification" aria-hidden="true" class="header-anchor">#</a> Domain verification</h3> <p>You've probably already gone through the domain verification process in part 1 of this series. This allows you to whitelist your application domain and prove that you own it so that Google can start sending webhook notifications.</p> <ul><li>If you have gone through all of it in the first article, <strong>just skip to the next section</strong>.</li> <li><a href="https://gist.github.com/lorisleiva/36c0173ddf082f1495d25aca119ace7e#domain-verification" target="_blank" rel="noopener noreferrer">If you have gone through setting up the Google API credentials but not domain verification, click here.<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li> <li><a href="https://gist.github.com/lorisleiva/36c0173ddf082f1495d25aca119ace7e" target="_blank" rel="noopener noreferrer">If you haven't gone through any of that process, click here.<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <p><small>If you're having troubles with Google's webhooks, make sure your <code>APP_URL</code> is using <code>https</code> as Google will not notify you on an unsecure URL.</small></p> <h3 id="asynchronous-jobs-with-laravel-horizon"><a href="#asynchronous-jobs-with-laravel-horizon" aria-hidden="true" class="header-anchor">#</a> Asynchronous jobs with Laravel Horizon</h3> <p>Since we are now making a significant amount of calls to the Google API after registering a new Google account, it would be more efficient to install Laravel Horizon and let those jobs run asynchronously after the Google account has been created. That way, the user does not have to wait a few seconds before the page can finally load.</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># Install and configure horizon.</span>
composer require laravel/horizon
php artisan vendor:publish --provider<span class="token operator">=</span><span class="token string">&quot;Laravel\Horizon\HorizonServiceProvider&quot;</span>

<span class="token comment"># Keep track of failed jobs.</span>
php artisan queue:failed-table
php artisan migrate

<span class="token comment"># Start horizon (or create a deamon).</span>
php artisan horizon
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># Update the queue drive in your .env file.</span>
QUEUE_DRIVER<span class="token operator">=</span>redis
</code></pre></div><p><small>I'm assuming you're familiar with Laravel Horizon, otherwise its <a href="https://laravel.com/docs/5.7/horizon" target="_blank" rel="noopener noreferrer">documentation<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> is very nice and clear as usual.</small></p> <p><small>üêô <a href="https://github.com/lorisleiva/blog-google-calendar/commit/31d4139b09bf38f58ad809068826f05411430147" target="_blank" rel="noopener noreferrer">See changes on GitHub<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></small></p> <h2 id="final-result"><a href="#final-result" aria-hidden="true" class="header-anchor">#</a> Final result</h2> <p>We did it! We now receive instant notifications from Google when something gets updated in your users' calendars and events. Here is a quick preview:</p> <p><img src="/assets/img/Kapture-2018-10-02-at-17.47.13.c0214609.gif" alt="Push notifications from Google preview"></p> <p>And here is an overview of the <code>Synchronization</code> life cycle.</p> <p><img src="/assets/img/Part-3---Summary.8703c9f3.png" alt="Synchronization Lifecycle"></p> <h2 id="conclusion"><a href="#conclusion" aria-hidden="true" class="header-anchor">#</a> Conclusion</h2> <p>I hope you liked this series and that you can see a whole new set of possibilities to add to your applications. ‚ú®</p> <p>I will very likely continue adding articles to this series so feel free to share any ideas of followed-up articles.</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f0379f84.js" defer></script><script src="/assets/js/2.f113c167.js" defer></script><script src="/assets/js/6.3a66a41c.js" defer></script>
  </body>
</html>
