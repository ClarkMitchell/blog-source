<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Wrap where clauses</title>
    <meta name="description" content="Laravel relationship methods are great to abstract database relationships but they also work really well to abstract complex relationships that span through multiple tables.">
    
    
    <link rel="preload" href="/assets/css/0.styles.d1fafc99.css" as="style"><link rel="preload" href="/assets/js/app.f0379f84.js" as="script"><link rel="preload" href="/assets/js/2.f113c167.js" as="script"><link rel="preload" href="/assets/js/17.53e9786c.js" as="script"><link rel="prefetch" href="/assets/js/10.463c40b2.js"><link rel="prefetch" href="/assets/js/11.41347932.js"><link rel="prefetch" href="/assets/js/12.160cf6fa.js"><link rel="prefetch" href="/assets/js/13.869049d5.js"><link rel="prefetch" href="/assets/js/14.6ab5dbac.js"><link rel="prefetch" href="/assets/js/15.5b213614.js"><link rel="prefetch" href="/assets/js/16.9b9d25f1.js"><link rel="prefetch" href="/assets/js/18.407766eb.js"><link rel="prefetch" href="/assets/js/19.ad818b5a.js"><link rel="prefetch" href="/assets/js/20.6a6cbda5.js"><link rel="prefetch" href="/assets/js/21.16473eda.js"><link rel="prefetch" href="/assets/js/22.17daa536.js"><link rel="prefetch" href="/assets/js/23.a3b585a7.js"><link rel="prefetch" href="/assets/js/24.693bd400.js"><link rel="prefetch" href="/assets/js/25.1cb8e654.js"><link rel="prefetch" href="/assets/js/3.e245ae37.js"><link rel="prefetch" href="/assets/js/4.32ef7c1a.js"><link rel="prefetch" href="/assets/js/5.1fabd509.js"><link rel="prefetch" href="/assets/js/6.3a66a41c.js"><link rel="prefetch" href="/assets/js/7.9038972a.js"><link rel="prefetch" href="/assets/js/8.0cd2f1f4.js"><link rel="prefetch" href="/assets/js/9.1449d7bd.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d1fafc99.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <!----> </aside> <main class="page"> <div class="content default"><h1 id="wrap-where-clauses"><a href="#wrap-where-clauses" aria-hidden="true" class="header-anchor">#</a> Wrap where clauses</h1> <p>Laravel relationship methods are great to abstract database relationships but they also work really well to abstract complex relationships that span through multiple tables.</p> <h2 id="an-example-of-increased-relationship"><a href="#an-example-of-increased-relationship" aria-hidden="true" class="header-anchor">#</a> An example of increased relationship</h2> <p>Let's say an <code>Article</code> has some <code>Images</code> and some <code>Comments</code> which also have some <code>Images</code>. The <code>Image</code> model is linked to the <code>Article</code> and <code>Comment</code> models via a polymorphic relationship.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token keyword">class</span> <span class="token class-name">Article</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">images</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">morphMany</span><span class="token punctuation">(</span>Image<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">comments</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">hasMany</span><span class="token punctuation">(</span>Comment<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Now, how would we go about fetching all images from an article including the images of its comments?</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// App\Article</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">getAllImagesAttribute</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token variable">$commentImages</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">comments</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">flatMap</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">images</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">images</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">merge</span><span class="token punctuation">(</span><span class="token variable">$commentImages</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>While this works fine, we have to fetch all comments and then for each of those comments fetch their images. If we have 100 comments, thats 101 queries just to fetch some images. How can we transform this into a simple Laravel relationship method that can be cached and requires only one database query?</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// App\Article</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">allImages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">images</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">orWhere</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$query</span> <span class="token punctuation">{</span>        
        <span class="token variable">$query</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'imageable_type'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'App\Comment'</span><span class="token punctuation">)</span>
              <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">whereExists</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token variable">$query</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token variable">$query</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">select</span><span class="token punctuation">(</span>\<span class="token package">DB</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">raw</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                        <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'comments'</span><span class="token punctuation">)</span>
                        <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">whereRaw</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'comments.id = image.imageable_id'</span><span class="token punctuation">)</span>
                        <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'article_id'</span><span class="token punctuation">,</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">id</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Let's run through that code:</p> <ol><li>We use the original <code>images()</code> relationship and add a <em>&quot;OR&quot; where clause</em> to extend it.</li> <li>In our <em>&quot;OR&quot; where clause</em>, we only want images that are linked to comments. Note that we already have the images associates with our article within the first part of the &quot;OR&quot;.</li> <li>Finally we only want images <code>where there exists</code> a row from the <code>comments</code> table such that its <code>id</code> equals our <code>imageable_id</code> and such that its <code>article_id</code> matches the id of our article.</li></ol> <p>Easy right? Now we can fully leverage the <code>allImages()</code> method as if it was a regular relationship method:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$article</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">allImages</span><span class="token punctuation">;</span> <span class="token comment">// Get them all.</span>
<span class="token variable">$article</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">allImages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">latest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">first</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Get the last once.</span>
<span class="token variable">$article</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">allImages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// Count them.</span>
</code></pre></div><h2 id="the-filtering-problem"><a href="#the-filtering-problem" aria-hidden="true" class="header-anchor">#</a> The filtering problem</h2> <p>Similarly we should be able to filter our relationship method like so:</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token variable">$article</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">allImages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">where</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'size'</span><span class="token punctuation">,</span> <span class="token single-quoted-string string">'&lt;'</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>However, the filtering above will not work as expected. To understand why, we need to have a look at the SQL query it generates.</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token comment">// This first part is generated by `$this-&gt;images()`</span>
<span class="token keyword">select</span> <span class="token operator">*</span> 
<span class="token keyword">from</span> <span class="token punctuation">`</span>images<span class="token punctuation">`</span> 
<span class="token keyword">where</span> <span class="token punctuation">`</span>images<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>imageable_id<span class="token punctuation">`</span> <span class="token operator">=</span> ?             <span class="token comment">// (A)</span>
    <span class="token operator">and</span> <span class="token punctuation">`</span>images<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>imageable_id<span class="token punctuation">`</span> <span class="token operator">is</span> <span class="token operator">not</span> <span class="token boolean">null</span>   <span class="token comment">// (B)</span>
    <span class="token operator">and</span> <span class="token punctuation">`</span>images<span class="token punctuation">`</span><span class="token punctuation">.</span><span class="token punctuation">`</span>imageable_type<span class="token punctuation">`</span> <span class="token operator">=</span> ?         <span class="token comment">// (C)</span>
    
    <span class="token comment">// This second part is our `orWhere` clause. (D)</span>
    <span class="token operator">or</span> <span class="token punctuation">(</span>
        <span class="token punctuation">`</span>imageable_type<span class="token punctuation">`</span> <span class="token operator">=</span> ? 
        <span class="token operator">and</span> <span class="token keyword">exists</span> <span class="token punctuation">(</span>
            <span class="token keyword">select</span> <span class="token number">1</span> 
            <span class="token keyword">from</span> <span class="token punctuation">`</span>comments<span class="token punctuation">`</span> 
            <span class="token keyword">where</span> images<span class="token punctuation">.</span>imageable_id <span class="token operator">=</span> comments<span class="token punctuation">.</span>id <span class="token operator">and</span> <span class="token punctuation">`</span>article_id<span class="token punctuation">`</span> <span class="token operator">=</span> ?
        <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
    
    <span class="token comment">// This third part is our size filtering.    (E)</span>
    <span class="token operator">and</span> <span class="token punctuation">`</span>size<span class="token punctuation">`</span> <span class="token operator">&lt;</span> ?
</code></pre></div><p>Because of the precedence of <code>and</code> over <code>or</code>, our size filter (E) only gets applied to our <em>&quot;OR&quot; where clause</em> (D), i.e. we are only filtering the images of the comments.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// instead of</span>
A <span class="token keyword">and</span> B <span class="token keyword">and</span> C <span class="token keyword">or</span> D <span class="token keyword">and</span> E
<span class="token comment">// which translates to</span>
<span class="token punctuation">(</span>A <span class="token keyword">and</span> B <span class="token keyword">and</span> C<span class="token punctuation">)</span> <span class="token keyword">or</span> <span class="token punctuation">(</span>D <span class="token keyword">and</span> E<span class="token punctuation">)</span>
<span class="token comment">// we want</span>
<span class="token punctuation">(</span>A <span class="token keyword">and</span> B <span class="token keyword">and</span> C <span class="token keyword">or</span> D<span class="token punctuation">)</span> <span class="token keyword">and</span> E
</code></pre></div><h2 id="macro-to-the-rescue"><a href="#macro-to-the-rescue" aria-hidden="true" class="header-anchor">#</a> Macro to the rescue</h2> <p>To fix this issue, we basically need to wrap all where clauses of our query builder into one nested where clause. I have created a macro that does that for you. I'll just paste it here with some comments if you're interested.</p> <div class="language-php extra-class"><pre class="language-php"><code><span class="token comment">// App\Providers\AppServiceProvider</span>
Relation<span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token function">macro</span><span class="token punctuation">(</span><span class="token single-quoted-string string">'wrapWhereClauses'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token variable">$boolean</span> <span class="token operator">=</span> <span class="token single-quoted-string string">'and'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// Get the query of the relation.</span>
    <span class="token variable">$query</span> <span class="token operator">=</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">getBaseQuery</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Create a new nested where group.</span>
    <span class="token variable">$whereGroup</span> <span class="token operator">=</span> <span class="token variable">$query</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">forNestedWhere</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Add all the query where clauses to the new where group.</span>
    <span class="token variable">$whereGroup</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">wheres</span> <span class="token operator">=</span> <span class="token variable">$query</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">wheres</span><span class="token punctuation">;</span>
    
    <span class="token comment">// Replace the query where clauses to include only this whereGroup.</span>
    <span class="token variable">$query</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token property">wheres</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">[</span>
        <span class="token single-quoted-string string">'type'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token single-quoted-string string">'Nested'</span><span class="token punctuation">,</span> 
        <span class="token single-quoted-string string">'query'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$whereGroup</span><span class="token punctuation">,</span> 
        <span class="token single-quoted-string string">'boolean'</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token variable">$boolean</span>
    <span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

    <span class="token comment">// Return this to continue chaining.</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Now just append this to your <code>allImages()</code> method.</p> <div class="language-php extra-class"><div class="highlight-lines"><br><br><br><br><div class="highlighted">Â </div><br><br></div><pre class="language-php"><code><span class="token comment">// App\Article</span>
<span class="token keyword">public</span> <span class="token keyword">function</span> <span class="token function">allImages</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token variable">$this</span><span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">images</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">orWhere</span><span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span>
                <span class="token operator">-</span><span class="token operator">&gt;</span><span class="token function">wrapWhereClauses</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>And now, any new where clause will be applied to all of the images as expected.</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f0379f84.js" defer></script><script src="/assets/js/2.f113c167.js" defer></script><script src="/assets/js/17.53e9786c.js" defer></script>
  </body>
</html>
